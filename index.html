<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>4択問題</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  body { font-family: "Noto Sans JP", "Inter", sans-serif; }
  .option { transition: background-color .2s, border-color .2s; cursor: pointer; }
  .option:not(.answered):hover { background-color: #f0f4ff; border-color: #a3bffa; }
  .correct { background-color: #e6fffa; border-color: #38a169; color: #2f855a; font-weight: 600; }
  .incorrect { background-color: #fff5f5; border-color: #e53e3e; color: #c53030; }
  .answered { cursor: default; }
  .explanation, .hint { display:none; margin-top: 1rem; padding: 1rem; border-left-width: 4px; }
  .explanation { background-color: #f7fafc; border-color: #4a5568; color: #2d3748; }
  .hint { background-color: #fffaf0; border-color: #f6e05e; color: #975a16; }
  .feedback-icon { font-size: 1.25rem; font-weight: bold; }
  .correct .feedback-icon::after { content: '〇'; color: #38a169; }
  .incorrect .feedback-icon::after { content: '?'; color: #e53e3e; }
  #resultModal.hidden { display: none; }
  #deletedModal.hidden { display: none; }
  details > summary { list-style: none; }
  details > summary::-webkit-details-marker { display: none; }
</style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
    
    <!-- コントロールパネル -->
    <section class="bg-white p-4 rounded-lg shadow-md mb-8">
      <!-- 上段：主要操作 -->
      <div class="flex flex-wrap items-center justify-end gap-2">
        <select id="csvSelect" class="border-gray-300 rounded-md shadow-sm text-sm p-2 flex-grow" title="問題セットを選択"></select>
        <select id="numSelect" class="border-gray-300 rounded-md shadow-sm text-sm p-2 w-20" title="出題数を選択">
          <option value="5">5問</option>
          <option value="10" selected>10問</option>
          <option value="20">20問</option>
          <option value="30">30問</option>
        </select>
        <button id="loadBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm hover:bg-blue-700 transition-colors duration-300">開始</button>
      </div>

      <!-- 下段：詳細設定とログ管理 -->
      <div class="mt-3 pt-3 border-t">
        <details>
          <summary class="cursor-pointer text-sm font-medium text-gray-600 hover:text-gray-900 flex items-center">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="[...]" /></svg>
            詳細設定・ログ管理
          </summary>
          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="minCorrect" class="block text-xs font-medium text-gray-500">除外条件: 最低正解回数</label>
              <input id="minCorrect" type="number" min="1" value="3" class="mt-1 w-full border-gray-300 rounded-md shadow-sm text-sm" />
            </div>
            <div>
              <label for="minRate" class="block text-xs font-medium text-gray-500">除外条件: 最低正答率 (%)</label>
              <input id="minRate" type="number" min="0" max="100" value="80" class="mt-1 w-full border-gray-300 rounded-md shadow-sm text-sm" />
            </div>
          </div>
          <div class="mt-4 pt-3 border-t flex flex-wrap items-center gap-2">
            <div class="flex items-center gap-2">
                <input id="soundToggle" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600" checked />
                <label for="soundToggle" class="text-sm text-gray-600">正解音</label>
            </div>
            <div class="flex-grow"></div>
            <button id="showStats" class="bg-gray-200 text-gray-700 px-3 py-1.5 rounded-md text-sm font-medium hover:bg-gray-300">ログを見る</button>
            <button id="exportStats" class="bg-green-100 text-green-800 px-3 py-1.5 rounded-md text-sm font-medium hover:bg-green-200">保存</button>
            <button id="importStats" class="bg-green-100 text-green-800 px-3 py-1.5 rounded-md text-sm font-medium hover:bg-green-200">読込</button>
            <input type="file" id="importFile" class="hidden" accept=".json">
            <button id="clearStats" class="bg-red-100 text-red-700 px-3 py-1.5 rounded-md text-sm font-medium hover:bg-red-200">リセット</button>
            <button id="manageDeletedBtn" class="bg-red-50 text-red-700 px-3 py-1.5 rounded-md text-sm font-medium hover:bg-red-100">削除済みの管理</button>
            <button id="copyCsvBtn" class="bg-indigo-100 text-indigo-800 px-3 py-1.5 rounded-md text-sm font-medium hover:bg-indigo-200">CSVをコピー（削除反映）</button>
          </div>
        </details>
      </div>
      <div id="notice" class="text-sm text-yellow-600 mt-2 text-center"></div>
    </section>

    <!-- 問題表示領域 -->
    <main id="quizArea" class="space-y-6"></main>

    <!-- 結果表示モーダル -->
    <div id="resultModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
      <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4 text-center">
        <h2 class="text-2xl font-bold mb-4">結果発表</h2>
        <p id="scoreText" class="text-4xl font-bold my-4 text-blue-600"></p>
        <p id="feedbackText" class="text-lg text-gray-700 mb-6"></p>
        <div class="space-y-3">
            <button id="retryBtn" class="w-full bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600">同じ問題でもう一度</button>
            <button id="newQuizBtn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">新しい問題で挑戦</button>
            <button id="closeModalBtn" class="w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">閉じる</button>
        </div>
      </div>
    </div>

    <!-- 削除済み管理モーダル -->
    <div id="deletedModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg mx-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">削除済みの問題（今後出題しない）</h3>
          <div class="flex items-center gap-2">
            <button id="restoreAllBtn" class="bg-green-100 text-green-800 px-3 py-1 rounded text-sm hover:bg-green-200">全復元</button>
            <button id="closeDeletedModal" class="bg-gray-100 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-200">閉じる</button>
          </div>
        </div>
        <div id="deletedList" class="space-y-2 text-sm text-gray-700 max-h-72 overflow-auto"></div>
        <p id="deletedNotice" class="text-xs text-gray-500 mt-3">（削除はユーザー側の設定で、CSV自体は書き換わりません）</p>
      </div>
    </div>

  </div>

<script>
/* ---------------- 設定 ---------------- */
const csvFilesFallback = ["knowledge.csv", "basic.csv"];
const STORAGE_KEY = "rccmDrillStats_v4_ID";
const DELETED_KEY = "rccmDrillDeleted_v1";

/* ---------------- DOM要素 ---------------- */
const csvSelect = document.getElementById("csvSelect");
const loadBtn = document.getElementById("loadBtn");
const retryBtn = document.getElementById("retryBtn");
const quizArea = document.getElementById("quizArea");
const numSelect = document.getElementById("numSelect");
const minCorrectInput = document.getElementById("minCorrect");
const minRateInput = document.getElementById("minRate");
const soundToggle = document.getElementById("soundToggle");
const clearStatsBtn = document.getElementById("clearStats");
const showStatsBtn = document.getElementById("showStats");
const exportStatsBtn = document.getElementById("exportStats");
const importStatsBtn = document.getElementById("importStats");
const importFile = document.getElementById("importFile");
const notice = document.getElementById("notice");
const resultModal = document.getElementById("resultModal");
const scoreText = document.getElementById("scoreText");
const feedbackText = document.getElementById("feedbackText");
const newQuizBtn = document.getElementById("newQuizBtn");
const closeModalBtn = document.getElementById("closeModalBtn");
const manageDeletedBtn = document.getElementById("manageDeletedBtn");
const deletedModal = document.getElementById("deletedModal");
const deletedList = document.getElementById("deletedList");
const closeDeletedModal = document.getElementById("closeDeletedModal");
const restoreAllBtn = document.getElementById("restoreAllBtn");
const copyCsvBtn = document.getElementById("copyCsvBtn");

/* ---- 初期化処理 ---- */
(async function init() {
  let list = [];
  try {
    const r = await fetch("index.json");
    if (r.ok) list = await r.json();
  } catch(e) { /* ignore */ }
  if (!Array.isArray(list) || list.length === 0) list = csvFilesFallback;
  list.forEach(f => {
    const opt = document.createElement("option");
    opt.value = f; opt.textContent = f;
    csvSelect.appendChild(opt);
  });
})();

/* ---- WebAudio APIによる効果音 ---- */
let audioCtx = null;
function ensureAudioCtx(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
function playTone(freq, startOffset, duration=0.16){
  ensureAudioCtx();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = "sine";
  o.frequency.value = freq;
  o.connect(g); g.connect(audioCtx.destination);
  const now = audioCtx.currentTime + startOffset;
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(0.18, now+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, now+duration);
  o.start(now); o.stop(now+duration+0.02);
}
function playDoReMi(){
  if (!soundToggle.checked) return;
  playTone(523.25, 0); // ド
  playTone(587.33, 0.14); // レ
  playTone(659.25, 0.28); // ミ
}

/* ---- CSVデータから問題オブジェクトを生成 ---- */
function buildQuestionsFromCSV(text){
  const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
  return parsed.data.map((row) => {
    const id = row["ID"] || "";
    const qText = row["問題"] || "";
    const correctText = row["正解"] || "";
    const opt2 = row["選択肢2"] || "";
    const opt3 = row["選択肢3"] || "";
    const opt4 = row["選択肢4"] || "";
    const explanation = row["解説"] || "";
    const hint = row["ヒント"] || "";
    
    if (!id || !qText || !correctText) return null;

    const rawOptions = [correctText, opt2, opt3, opt4].filter(Boolean);
    shuffleArray(rawOptions);

    const optionsMap = {};
    const labels = ["a", "b", "c", "d"];
    rawOptions.forEach((opt, i) => {
      optionsMap[labels[i]] = opt.trim();
    });

    const correctLabel = Object.keys(optionsMap).find(key => optionsMap[key] === correctText.trim());
    return { id: id.trim(), question: qText.trim(), options: optionsMap, answer: correctLabel, explanation: explanation.trim(), hint: hint.trim() };
  }).filter(Boolean);
}

/* ---- 学習ログ（Stats）の操作 ---- */
function loadStats(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }catch(e){return{}} }
function saveStats(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }

/* ---- 削除済み問題リストの操作 ---- */
function loadDeleted(){ try{ return JSON.parse(localStorage.getItem(DELETED_KEY) || "[]"); }catch(e){ return []; } }
function saveDeleted(arr){ localStorage.setItem(DELETED_KEY, JSON.stringify(arr)); }

/* ---- 出題除外条件の判定 ---- */
function shouldExclude(q, stats, minCorrect, minRate){
  const rec = stats[q.id] || { correct:0, total:0 };
  if (rec.total === 0) return false;
  const rate = (rec.correct / rec.total) * 100;
  return (rec.correct >= minCorrect) && (rate >= minRate);
}

/* ---- 問題の読み込みと表示 ---- */
let currentSet = [], allQuestions = [], statsCache = loadStats(), answeredCount = 0;

async function loadAndRender(isRetry = false) {
  notice.textContent = "";
  quizArea.innerHTML = "";
  answeredCount = 0;
  resultModal.classList.add("hidden");
  statsCache = loadStats();

  const filename = csvSelect.value;
  const num = parseInt(numSelect.value,10) || 10;
  const minCorrect = parseInt(minCorrectInput.value,10) || 3;
  const minRate = parseFloat(minRateInput.value) || 80;
  const deletedIds = new Set(loadDeleted());

  try {
    if (!isRetry || allQuestions.length === 0 || !allQuestions.some(q => q.id.startsWith(filename.split('.')[0]))) {
      const r = await fetch(filename);
      if (!r.ok) throw new Error(`CSVファイル「${filename}」の取得に失敗しました。`);
      const text = await r.text();
      allQuestions = buildQuestionsFromCSV(text);
    }

    // 削除済みIDを除外
    const filteredAll = allQuestions.filter(q => !deletedIds.has(q.id));

    let candidates = filteredAll.filter(q => !shouldExclude(q, statsCache, minCorrect, minRate));
    // 足りなければ学習済み（除外された）から補う（ただし削除済みは含めない）
    if (candidates.length < num && filteredAll.length >= num) {
      notice.textContent = `苦手問題が${candidates.length}問しかありませんでした。学習済みの問題から補充して出題します。`;
      const excluded = filteredAll.filter(q => shouldExclude(q, statsCache, minCorrect, minRate));
      shuffleArray(excluded);
      candidates.push(...excluded.slice(0, num - candidates.length));
    }
    shuffleArray(candidates);
    currentSet = candidates.slice(0, Math.min(num, filteredAll.length));
    
    if (currentSet.length === 0) {
        notice.textContent = "出題できる問題がありません。詳細設定の条件を緩めるか、削除済みの問題を復元してください。";
        return;
    }
    renderAll(currentSet);
  } catch(err) {
    quizArea.innerHTML = `<div class="bg-red-100 p-4 rounded text-red-700">${err.message}</div>`;
    console.error(err);
  }
}

/* ---- 全問題カードの描画 ---- */
function renderAll(set){
  quizArea.innerHTML = "";
  set.forEach((q, idx) => {
    const card = document.createElement("div");
    card.className = "bg-white p-6 rounded-lg shadow-md";

    const header = document.createElement("div");
    header.className = "flex justify-between items-start mb-4";
    
    const titleContainer = document.createElement("div");
    titleContainer.className = "flex-1 mr-4";
    
    const questionTitle = document.createElement("p");
    questionTitle.className = "font-bold text-lg";
    questionTitle.innerHTML = `<span class="text-blue-600 font-semibold">問${idx + 1}.</span> ${q.question}`;
    
    const questionId = document.createElement("p");
    questionId.className = "text-xs text-gray-400 mt-1";
    questionId.textContent = `ID: ${q.id}`;
    
    titleContainer.appendChild(questionTitle);
    titleContainer.appendChild(questionId);
    
    const rightGroup = document.createElement("div");
    rightGroup.className = "flex items-center gap-2";

    const statsBadge = document.createElement("div");
    statsBadge.className = "stats-badge text-xs font-bold px-2.5 py-1 rounded-full text-white whitespace-nowrap";
    updateStatsBadge(statsBadge, q.id);

    // 削除ボタン
    const deleteBtn = document.createElement("button");
    deleteBtn.className = "bg-red-50 text-red-700 px-2 py-1 rounded text-xs font-medium hover:bg-red-100";
    deleteBtn.textContent = "削除";
    deleteBtn.title = "この問題を今後出題しないようにする";
    deleteBtn.addEventListener("click", (ev) => {
      ev.stopPropagation();
      if (!confirm("この問題を削除（今後出題しない）しますか？\n（CSV自体は変更されず、あなたのブラウザ設定で記録されます）")) return;
      const deleted = loadDeleted();
      if (!deleted.includes(q.id)) {
        deleted.push(q.id);
        saveDeleted(deleted);
      }
      // remove from currentSet and DOM
      currentSet = currentSet.filter(c => c.id !== q.id);
      card.remove();
      notice.textContent = "問題を削除しました。削除済みの管理から復元できます。";
      // If all remaining questions answered -> show result
      if (answeredCount === currentSet.length) {
        showResult();
      }
    });

    rightGroup.appendChild(statsBadge);
    rightGroup.appendChild(deleteBtn);

    header.appendChild(titleContainer);
    header.appendChild(rightGroup);
    card.appendChild(header);

    if (q.hint) {
        const hintBtn = document.createElement("button");
        hintBtn.className = "bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-yellow-200 mb-4";
        hintBtn.textContent = "ヒントを見る";
        card.appendChild(hintBtn);
        const hintEl = document.createElement("div");
        hintEl.className = "hint";
        hintEl.innerHTML = `<strong class="font-semibold">【ヒント】</strong> ${q.hint}`;
        card.appendChild(hintEl);
        hintBtn.addEventListener("click", () => {
          hintEl.style.display = hintEl.style.display === "block" ? "none" : "block";
          hintBtn.textContent = hintEl.style.display === "block" ? "ヒントを隠す" : "ヒントを見る";
        });
    }

    const optsContainer = document.createElement("div");
    optsContainer.className = "options-container space-y-3";
    Object.keys(q.options).forEach(lbl => {
      const txt = q.options[lbl];
      const opt = document.createElement("div");
      opt.className = "option border border-gray-300 p-3 rounded-lg flex justify-between items-center";
      opt.dataset.label = lbl;
      opt.innerHTML = `<span><span class="font-bold mr-3">${lbl.toUpperCase()}.</span>${txt}</span><span class="feedback-icon"></span>`;
      opt.addEventListener("click", () => onOptionClick(opt, q, card));
      optsContainer.appendChild(opt);
    });
    card.appendChild(optsContainer);

    const exp = document.createElement("div");
    exp.className = "explanation";
    exp.innerHTML = `<p><strong class="font-semibold">【解説】</strong> ${q.explanation || "（解説なし）"}</p>`;
    card.appendChild(exp);

    quizArea.appendChild(card);
  });
}

/* ---- ステータスバッジの更新 ---- */
function updateStatsBadge(badge, qid) {
    const st = statsCache[qid] || { correct: 0, total: 0 };
    const rate = st.total > 0 ? (st.correct / st.total) * 100 : -1;

    badge.textContent = `${st.correct}/${st.total}`;
    badge.classList.remove("bg-gray-400", "bg-red-500", "bg-yellow-500", "bg-green-500");

    if (rate === -1) {
        badge.classList.add("bg-gray-400");
        badge.textContent = "未解答";
    } else if (rate < 50) {
        badge.classList.add("bg-red-500");
    } else if (rate < 80) {
        badge.classList.add("bg-yellow-500");
    } else {
        badge.classList.add("bg-green-500");
    }
}

/* ---- 選択肢クリック時の処理 ---- */
function onOptionClick(optEl, q, cardEl){
  const optsContainer = cardEl.querySelector(".options-container");
  if (optsContainer.classList.contains("answered")) return;
  optsContainer.classList.add("answered");

  answeredCount++;
  const selectedLbl = optEl.dataset.label;
  const correctLbl = q.answer;
  
  cardEl.querySelectorAll(".option").forEach(o => {
    o.classList.add("answered");
    if (o.dataset.label === correctLbl) o.classList.add("correct");
  });

  if (selectedLbl !== correctLbl) {
    optEl.classList.add("incorrect");
  } else {
    playDoReMi();
  }

  const exp = cardEl.querySelector(".explanation");
  if (exp) exp.style.display = "block";

  const stats = loadStats();
  if (!stats[q.id]) stats[q.id] = { correct:0, total:0 };
  stats[q.id].total++;
  if (selectedLbl === correctLbl) stats[q.id].correct++;
  saveStats(stats);
  statsCache = stats;

  const statsBadge = cardEl.querySelector(".stats-badge");
  updateStatsBadge(statsBadge, q.id);

  if (answeredCount === currentSet.length) {
    showResult();
  }
}

/* ---- 結果表示処理 ---- */
function showResult() {
    let correctCount = 0;
    // 選択されたカード（DOM上にあるもの）で正答数を数える
    quizArea.querySelectorAll('.bg-white.p-6').forEach(card => {
        if (!card.querySelector('.option.incorrect')) {
            if (card.querySelector('.options-container.answered')) {
                correctCount++;
            }
        }
    });

    const total = currentSet.length;
    scoreText.textContent = `${correctCount} / ${total} 正解`;
    
    let feedback = '';
    const rate = total > 0 ? (correctCount / total) * 100 : 0;
    if (rate === 100) feedback = '素晴らしい！全問正解です。完璧です！';
    else if (rate >= 80) feedback = '優秀です！この調子で知識を定着させましょう。';
    else if (rate >= 60) feedback = 'まずまずの成績です。間違えた問題の解説をしっかり復習しましょう。';
    else feedback = 'まだまだ伸びしろがありますね。繰り返し挑戦して苦手分野を克服しましょう！';
    feedbackText.textContent = feedback;

    resultModal.classList.remove('hidden');
}

/* ---- ユーティリティ関数 ---- */
function shuffleArray(a){ for (let i=a.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

/* ---- CSVをコピー（削除済みを反映） ---- */
async function copyCsvExcludingDeleted() {
  const filename = csvSelect.value;
  const deleted = new Set(loadDeleted());

  try {
    const r = await fetch(filename);
    if (!r.ok) throw new Error(`CSVファイル「${filename}」の取得に失敗しました。`);
    const text = await r.text();

    // parse with header (keep empty lines to preserve structure; remove only rows we need)
    const parsed = Papa.parse(text, { header: true, skipEmptyLines: false });
    if (!parsed || !Array.isArray(parsed.data)) throw new Error("CSVの解析に失敗しました。");

    // If parsed.data is an array of objects, filter by ID
    const filtered = parsed.data.filter(row => {
      // If the row is entirely empty (all values empty), keep it
      const hasAny = Object.values(row).some(v => v !== null && v !== undefined && String(v).trim() !== "");
      if (!hasAny) return true;
      const id = (row["ID"] || "").toString().trim();
      return id === "" ? true : !deleted.has(id);
    });

    // Determine fields/order: prefer parsed.meta.fields if available
    const fields = (parsed.meta && parsed.meta.fields) ? parsed.meta.fields : Object.keys(filtered[0] || {});
    const csvOut = Papa.unparse({ fields: fields, data: filtered });

    // Copy to clipboard. BOM not necessary for GitHub paste; keep it off by default.
    const finalText = csvOut;

    if (navigator.clipboard && navigator.clipboard.writeText) {
      await navigator.clipboard.writeText(finalText);
      alert("CSV（削除済みを反映）をクリップボードにコピーしました。\nGitHubのファイル編集画面に貼り付けて保存してください。");
    } else {
      // Fallback: temporary textarea
      const ta = document.createElement("textarea");
      ta.value = finalText;
      document.body.appendChild(ta);
      ta.select();
      try {
        document.execCommand("copy");
        alert("CSVをクリップボードにコピーしました（フォールバック）。GitHubに貼り付けてください。");
      } catch (e) {
        alert("コピーに失敗しました。以下のテキストを手動でコピーしてください。");
        const w = window.open("", "_blank");
        w.document.write("<pre>" + escapeHtml(finalText) + "</pre>");
      } finally {
        document.body.removeChild(ta);
      }
    }
  } catch (err) {
    alert("CSVのコピーに失敗しました: " + err.message);
    console.error(err);
  }
}
function escapeHtml(s){ return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

/* ---- 削除済み管理モーダル処理 ---- */
function openDeletedModal(){
  renderDeletedList();
  deletedModal.classList.remove('hidden');
}
function closeDeletedModalFn(){
  deletedModal.classList.add('hidden');
}
function renderDeletedList(){
  const deleted = loadDeleted();
  deletedList.innerHTML = "";
  if (deleted.length === 0) {
    deletedList.innerHTML = `<p class="text-sm text-gray-500">削除済みの問題はありません。</p>`;
    return;
  }
  deleted.forEach(id => {
    const row = document.createElement("div");
    row.className = "flex items-center justify-between p-2 border rounded";
    const left = document.createElement("div");
    left.className = "text-sm font-medium";
    left.textContent = id;
    const right = document.createElement("div");
    const restoreBtn = document.createElement("button");
    restoreBtn.className = "bg-blue-50 text-blue-700 px-2 py-0.5 rounded text-xs hover:bg-blue-100";
    restoreBtn.textContent = "復元";
    restoreBtn.addEventListener("click", () => {
      if (!confirm(`${id} を復元して出題対象に戻しますか？`)) return;
      const arr = loadDeleted().filter(x => x !== id);
      saveDeleted(arr);
      renderDeletedList();
      notice.textContent = "復元しました。問題を開始してください。";
    });
    const removePermanentlyBtn = document.createElement("button");
    removePermanentlyBtn.className = "ml-2 bg-red-50 text-red-700 px-2 py-0.5 rounded text-xs hover:bg-red-100";
    removePermanentlyBtn.textContent = "完全に削除";
    removePermanentlyBtn.title = "ローカルの削除リストからも消します（復元できなくなります）";
    removePermanentlyBtn.addEventListener("click", () => {
      if (!confirm(`${id} を完全に削除リストからも消します。復元できなくなりますがよいですか？`)) return;
      const arr = loadDeleted().filter(x => x !== id);
      saveDeleted(arr);
      renderDeletedList();
    });
    right.appendChild(restoreBtn);
    right.appendChild(removePermanentlyBtn);
    row.appendChild(left);
    row.appendChild(right);
    deletedList.appendChild(row);
  });
}
function restoreAllDeleted(){
  if (!confirm("削除済みリストをすべて復元しますか？")) return;
  saveDeleted([]);
  renderDeletedList();
  notice.textContent = "すべて復元しました。問題を開始してください。";
}

/* ---- イベントリスナー設定 ---- */
loadBtn.addEventListener("click", () => loadAndRender(false));
retryBtn.addEventListener("click", () => {
    if (currentSet.length > 0) {
        answeredCount = 0;
        resultModal.classList.add("hidden");
        renderAll(currentSet);
    }
});
newQuizBtn.addEventListener("click", () => loadAndRender(false));
closeModalBtn.addEventListener("click", () => resultModal.classList.add("hidden"));

clearStatsBtn.addEventListener("click", () => {
  if (confirm("すべての学習ログをリセットします。本当によろしいですか？")) {
    localStorage.removeItem(STORAGE_KEY);
    statsCache = loadStats();
    alert("学習ログをリセットしました。");
    quizArea.innerHTML = "";
    notice.textContent = "";
  }
});
showStatsBtn.addEventListener("click", () => {
  const s = loadStats();
  const keys = Object.keys(s);
  const deleted = loadDeleted();
  if (keys.length === 0 && deleted.length === 0) return alert("学習ログ・削除リストはまだありません。");
  let msg = "--- 学習ログ ---\nID :: 正答 / 試行 (正答率)\n\n";
  keys.sort().forEach(k => {
    const rate = s[k].total > 0 ? ((s[k].correct/s[k].total)*100).toFixed(1) : "0.0";
    msg += `${k} :: ${s[k].correct} / ${s[k].total} (${rate}%)\n`;
  });
  if (deleted.length > 0) {
    msg += `\n--- 削除済み（今後出題しない） ---\n`;
    deleted.forEach(d => { msg += `${d}\n`; });
  }
  alert(msg);
});
exportStatsBtn.addEventListener("click", () => {
    const stats = loadStats();
    if (Object.keys(stats).length === 0 && loadDeleted().length === 0) {
        alert("保存する学習ログ・削除リストがありません。");
        return;
    }
    const exportObj = { stats: stats, deleted: loadDeleted() };
    const blob = new Blob([JSON.stringify(exportObj, null, 2)], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "rccm_drill_log_and_deleted.json";
    a.click();
    URL.revokeObjectURL(url);
    alert("学習ログと削除リストを保存しました。");
});
importStatsBtn.addEventListener("click", () => importFile.click());
importFile.addEventListener("change", (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const imported = JSON.parse(e.target.result);
            // 互換性: 旧形式（statsのみ）のままならそのまま適用
            let importedStats = null;
            let importedDeleted = null;
            if (imported && typeof imported === "object" && ("stats" in imported || "deleted" in imported)) {
              importedStats = imported.stats || {};
              importedDeleted = imported.deleted || [];
            } else {
              // plain stats object
              importedStats = imported;
            }

            if (!confirm("現在の学習ログを上書きして、読み込んだログ（および削除リスト）を適用します。よろしいですか？")) return;

            if (importedStats) saveStats(importedStats);
            if (importedDeleted) saveDeleted(importedDeleted);
            statsCache = loadStats();
            alert("学習ログと削除リストを読み込みました。");
            quizArea.innerHTML = "";
            notice.textContent = "ログを読み込みました。問題を開始してください。";
        } catch (err) {
            alert("ファイルの読み込みに失敗しました。有効なJSONファイルではありません。");
        }
    };
    reader.readAsText(file);
    event.target.value = '';
});

manageDeletedBtn.addEventListener("click", () => openDeletedModal());
closeDeletedModal.addEventListener("click", () => closeDeletedModalFn());
restoreAllBtn.addEventListener("click", restoreAllDeleted);

copyCsvBtn.addEventListener("click", copyCsvExcludingDeleted);

/* ------------------- 補足 ------------------- */
/* - 削除はユーザーブラウザのlocalStorageに記録します（CSV本体は変更されません）。 */
/* - 削除済みは「削除済みの管理」から復元または一括復元できます。 */
/* - 「CSVをコピー（削除反映）」は現在選択されているCSVファイルを fetch -> parse -> 削除済みIDを除外 -> unparse してクリップボードにコピーします。 */
</script>
</body>
</html>
