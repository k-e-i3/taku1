<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>建設コンサルタント 択一ドリル</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<link href="https://cdn.tailwindcss.com" rel="stylesheet">
<style>
  body { font-family: "Noto Sans JP", "Inter", sans-serif; }
  .option { transition: background-color .14s, border-color .14s; cursor: pointer; }
  .correct { background:#e6fffa; border-color:#38a169; color:#2f855a; }
  .incorrect { background:#fff5f5; border-color:#e53e3e; color:#c53030; }
  .answered { cursor: default; pointer-events: none; opacity: .95; }
  .explanation { display:none; margin-top:.5rem; padding:.6rem; background:#f7fafc; border-left:4px solid #4a5568; color:#2d3748; }
  .hint { display:none; margin-top:.5rem; padding:.5rem; background:#fffaf0; border-left:4px solid #b7791f; color:#7a5a00; }
  .card { min-width: 0; } /* for tailwind */
</style>
</head>
<body class="bg-gray-100 text-gray-900 p-4 sm:p-6">
  <div class="max-w-5xl mx-auto">
    <header class="text-center mb-4">
      <h1 class="text-2xl font-bold">建設コンサルタント 択一ドリル</h1>
      <p class="text-sm text-gray-600 mt-1">CSVを読み込み、学習状況に応じてランダムに出題します。正解時はドレミ音、誤答は無音。</p>
    </header>

    <!-- コントロール -->
    <section class="bg-white p-4 rounded-lg shadow mb-4">
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3">
        <div>
          <label class="block text-sm font-medium mb-1">問題セット (CSV)</label>
          <select id="csvSelect" class="w-full border p-2 rounded-md bg-gray-50"></select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">出題数</label>
          <select id="numSelect" class="w-full border p-2 rounded-md bg-gray-50">
            <option value="5">5問</option>
            <option value="10" selected>10問</option>
            <option value="20">20問</option>
            <option value="30">30問</option>
          </select>
        </div>
        <div class="flex items-end">
             <div class="flex items-center gap-2 p-2 border rounded-md">
                <input id="soundToggle" type="checkbox" class="h-4 w-4 rounded" checked />
                <label for="soundToggle" class="text-sm">正解時に音を鳴らす</label>
             </div>
        </div>
        <div class="flex items-end gap-2">
          <button id="loadBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 transition">読み込んで出題</button>
        </div>
      </div>

      <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3 border-t pt-3">
        <div>
          <label class="text-sm font-medium">除外条件: 最低正解回数</label>
          <input id="minCorrect" type="number" min="1" value="3" class="w-full border p-2 rounded-md mt-1" />
          <p class="text-xs text-gray-500 mt-1">例: 3回以上正解した問題は出題候補から除外</p>
        </div>
        <div>
          <label class="text-sm font-medium">除外条件: 最低正答率 (%)</label>
          <input id="minRate" type="number" min="0" max="100" value="80" class="w-full border p-2 rounded-md mt-1" />
          <p class="text-xs text-gray-500 mt-1">例: 正答率が80%以上の問題は出題候補から除外</p>
        </div>
      </div>

      <div class="mt-4 flex flex-wrap gap-2 border-t pt-3">
        <button id="retryBtn" class="bg-indigo-500 text-white px-3 py-2 rounded-md text-sm">同じ問題でもう一度</button>
        <button id="clearStats" class="bg-gray-200 px-3 py-2 rounded-md text-sm hover:bg-gray-300">学習ログをクリア</button>
        <button id="showStats" class="bg-gray-200 px-3 py-2 rounded-md text-sm hover:bg-gray-300">統計を見る</button>
        <span id="notice" class="text-sm text-red-600 ml-3 self-center"></span>
      </div>
    </section>

    <!-- 問題一括表示領域 -->
    <main id="quizArea" class="space-y-4"></main>
  </div>

<script>
/* ---------------- 設定 ---------------- */
const csvFilesFallback = ["knowledge.csv", "basic.csv"]; // index.jsonがない場合のフォールバック
const STORAGE_KEY = "quizStats_v2"; // バージョンアップ

/* ---------------- DOM ---------------- */
const csvSelect = document.getElementById("csvSelect");
const loadBtn = document.getElementById("loadBtn");
const retryBtn = document.getElementById("retryBtn");
const quizArea = document.getElementById("quizArea");
const numSelect = document.getElementById("numSelect");
const minCorrectInput = document.getElementById("minCorrect");
const minRateInput = document.getElementById("minRate");
const soundToggle = document.getElementById("soundToggle");
const clearStatsBtn = document.getElementById("clearStats");
const showStatsBtn = document.getElementById("showStats");
const notice = document.getElementById("notice");

/* ---- 初期化: index.json 試行 -> フォールバック ---- */
(async function init() {
  let list = [];
  try {
    const r = await fetch("index.json");
    if (r.ok) list = await r.json();
  } catch(e) { /* ignore */ }
  if (!Array.isArray(list) || list.length === 0) list = csvFilesFallback;
  list.forEach(f => {
    const opt = document.createElement("option");
    opt.value = f; opt.textContent = f;
    csvSelect.appendChild(opt);
  });
})();

/* ---- WebAudio: playDoReMi ---- */
let audioCtx = null;
function ensureAudioCtx(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
function playTone(freq, startOffset, duration=0.16){
  ensureAudioCtx();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = "sine";
  o.frequency.value = freq;
  o.connect(g); g.connect(audioCtx.destination);
  const now = audioCtx.currentTime + startOffset;
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(0.18, now+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, now+duration);
  o.start(now); o.stop(now+duration+0.02);
}
function playDoReMi(){
  playTone(261.63, 0);
  playTone(293.66, 0.16);
  playTone(329.63, 0.32);
}

/* ---- CSV -> questions 構築 ---- */
function buildQuestionsFromCSV(text, filename){
  const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
  return parsed.data.map((row, idx) => {
    const qText = row["問題"] || row["question"] || "";
    const correctText = row["正解"] || row["answer"] || "";
    const opt2 = row["選択肢2"] || "";
    const opt3 = row["選択肢3"] || "";
    const opt4 = row["選択肢4"] || "";
    const explanation = row["解説"] || "";
    const hint = row["ヒント"] || "";

    if (!qText || !correctText) return null;

    const rawOptions = [correctText, opt2, opt3, opt4].filter(Boolean);
    shuffleArray(rawOptions); // 選択肢をシャッフル

    const optionsMap = {};
    const labels = ["a", "b", "c", "d"];
    rawOptions.forEach((opt, i) => {
      optionsMap[labels[i]] = opt.trim();
    });

    const correctLabel = Object.keys(optionsMap).find(key => optionsMap[key] === correctText.trim());
    const qid = `${filename}::${idx+1}`;
    return { id: qid, question: qText.trim(), options: optionsMap, answer: correctLabel, explanation: explanation.trim(), hint: hint.trim() };
  }).filter(Boolean);
}


/* ---- stats 操作 ---- */
function loadStats(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }catch(e){return{}} }
function saveStats(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }

/* ---- 除外判定 ---- */
function shouldExclude(q, stats, minCorrect, minRate){
  const rec = stats[q.id] || { correct:0, total:0 };
  if (rec.total === 0) return false;
  const rate = (rec.correct / rec.total) * 100;
  return (rec.correct >= minCorrect) && (rate >= minRate);
}

/* ---- 出題（全問一括レンダリング） ---- */
let currentSet = [], allQuestions = [], statsCache = loadStats();

async function loadAndRender(isRetry = false) {
  notice.textContent = "";
  quizArea.innerHTML = "";
  statsCache = loadStats();

  const filename = csvSelect.value;
  const num = parseInt(numSelect.value,10) || 10;
  const minCorrect = parseInt(minCorrectInput.value,10) || 3;
  const minRate = parseFloat(minRateInput.value) || 80;

  try {
    if (!isRetry) { // 初回読み込み時のみCSVをフェッチ
        const r = await fetch(filename);
        if (!r.ok) throw new Error("CSV取得失敗: "+r.status);
        const text = await r.text();
        allQuestions = buildQuestionsFromCSV(text, filename);
    }

    let candidates = allQuestions.filter(q => !shouldExclude(q, statsCache, minCorrect, minRate));
    if (candidates.length < num && allQuestions.length >= num) {
      notice.textContent = `候補が不足(${candidates.length}/${num})。除外中の問題から補充します。`;
      const excluded = allQuestions.filter(q => shouldExclude(q, statsCache, minCorrect, minRate));
      shuffleArray(excluded);
      candidates.push(...excluded);
    }
    shuffleArray(candidates);
    currentSet = candidates.slice(0, Math.min(num, allQuestions.length));
    renderAll(currentSet);
  } catch(err) {
    quizArea.innerHTML = `<div class="bg-red-100 p-4 rounded text-red-700">読み込みエラー: ${err.message}</div>`;
    console.error(err);
  }
}

/* 一括描画 */
function renderAll(set){
  quizArea.innerHTML = "";
  set.forEach((q, idx) => {
    const card = document.createElement("div");
    card.className = "card bg-white p-5 rounded-lg shadow";

    const header = document.createElement("div");
    header.className = "flex justify-between items-start";
    header.innerHTML = `<div class="text-sm font-semibold text-blue-700">問 ${idx+1}</div><div class="text-xs text-gray-400">${q.id}</div>`;
    card.appendChild(header);

    const p = document.createElement("p");
    p.className = "font-bold text-lg mt-2";
    p.textContent = q.question;
    card.appendChild(p);

    const btnRow = document.createElement("div");
    btnRow.className = "mt-3 flex items-center gap-3";
    
    const st = statsCache[q.id] || { correct:0, total:0 };
    const statSpan = document.createElement("div");
    statSpan.className = "text-sm text-gray-500";
    statSpan.textContent = `学習ログ: 正答 ${st.correct} / 試行 ${st.total}`;
    btnRow.appendChild(statSpan);
    
    if (q.hint) {
        const hintBtn = document.createElement("button");
        hintBtn.className = "bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-yellow-200";
        hintBtn.textContent = "ヒント";
        btnRow.appendChild(hintBtn);
        const hintEl = document.createElement("div");
        hintEl.className = "hint";
        hintEl.innerHTML = `<strong>ヒント:</strong> ${q.hint}`;
        card.appendChild(hintEl);
        hintBtn.addEventListener("click", () => {
          hintEl.style.display = hintEl.style.display === "block" ? "none" : "block";
        });
    }
    card.appendChild(btnRow);

    const optsContainer = document.createElement("div");
    optsContainer.className = "mt-4 grid grid-cols-1 gap-3";
    Object.keys(q.options).forEach(lbl => {
      const txt = q.options[lbl];
      const opt = document.createElement("div");
      opt.className = "option border border-gray-300 p-3 rounded-lg flex justify-between items-center";
      opt.dataset.label = lbl;
      opt.innerHTML = `<span><span class="font-bold mr-2">${lbl.toUpperCase()}.</span>${txt}</span>`;
      opt.addEventListener("click", () => onOptionClickCard(opt, q, card, statSpan));
      optsContainer.appendChild(opt);
    });
    card.appendChild(optsContainer);

    const exp = document.createElement("div");
    exp.className = "explanation";
    exp.innerHTML = `<p><strong>【解説】</strong> ${q.explanation || "（解説なし）"}</p>`;
    card.appendChild(exp);

    quizArea.appendChild(card);
  });
}

/* 回答処理 */
function onOptionClickCard(optEl, q, cardEl, statSpan){
  const optsContainer = cardEl.querySelector(".mt-4");
  if (optsContainer.classList.contains("answered")) return;
  optsContainer.classList.add("answered");

  const selectedLbl = optEl.dataset.label;
  const correctLbl = q.answer;
  
  cardEl.querySelectorAll(".option").forEach(o => {
    const currentLbl = o.dataset.label;
    if (currentLbl === correctLbl) {
      o.classList.add("correct");
      o.innerHTML += `<span class="font-bold text-lg">〇</span>`;
    } else if (currentLbl === selectedLbl) {
      o.classList.add("incorrect");
      o.innerHTML += `<span class="font-bold text-lg">✕</span>`;
    }
  });

  if (selectedLbl === correctLbl) {
    if (soundToggle.checked) playDoReMi();
  }

  const exp = cardEl.querySelector(".explanation");
  if (exp) exp.style.display = "block";

  const stats = loadStats();
  if (!stats[q.id]) stats[q.id] = { correct:0, total:0 };
  stats[q.id].total++;
  if (selectedLbl === correctLbl) stats[q.id].correct++;
  saveStats(stats);
  statsCache = stats;
  const s = stats[q.id];
  statSpan.textContent = `学習ログ: 正答 ${s.correct} / 試行 ${s.total}`;
}

/* ユーティリティ */
function shuffleArray(a){ for (let i=a.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

/* イベント */
loadBtn.addEventListener("click", () => loadAndRender(false));
retryBtn.addEventListener("click", () => {
    if (currentSet.length > 0) {
        renderAll(currentSet); // 同じ問題セットで再描画
    }
});
clearStatsBtn.addEventListener("click", () => {
  if (confirm("学習ログを完全に削除します。よろしいですか？")) {
    localStorage.removeItem(STORAGE_KEY);
    statsCache = loadStats();
    alert("クリアしました。");
    loadAndRender(true); // 表示を更新
  }
});
showStatsBtn.addEventListener("click", () => {
  const s = loadStats();
  const keys = Object.keys(s);
  if (keys.length === 0) return alert("統計データはありません。");
  let msg = "問題ID :: 正答 / 試行 (正答率)\n\n";
  keys.forEach(k => {
    const rate = s[k].total > 0 ? ((s[k].correct/s[k].total)*100).toFixed(1) : "0.0";
    msg += `${k} :: ${s[k].correct} / ${s[k].total} (${rate}%)\n`;
  });
  if (msg.length > 2000) {
    console.log(s);
    return alert("統計データはコンソールに出力しました（長すぎるため）。");
  }
  alert(msg);
});
</script>
</body>
</html>
