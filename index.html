<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>4択ドリル</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  body { font-family: "Noto Sans JP", "Inter", sans-serif; }
  .option { transition: background-color .2s, border-color .2s; cursor: pointer; }
  .option:not(.answered):hover { background-color: #f0f4ff; border-color: #a3bffa; }
  .correct { background-color: #e6fffa; border-color: #38a169; color: #2f855a; font-weight: 600; }
  .incorrect { background-color: #fff5f5; border-color: #e53e3e; color: #c53030; }
  .answered { cursor: default; }
  .explanation, .hint { display:none; margin-top: 1rem; padding: 1rem; border-left-width: 4px; }
  .explanation { background-color: #f7fafc; border-color: #4a5568; color: #2d3748; }
  .hint { background-color: #fffaf0; border-color: #f6e05e; color: #975a16; }
  .feedback-icon { font-size: 1.25rem; font-weight: bold; }
  .correct .feedback-icon::after { content: '〇'; color: #38a169; }
  .incorrect .feedback-icon::after { content: '✕'; color: #e53e3e; }
  #resultModal.hidden { display: none; }
</style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
    <header class="text-center mb-8">
      <h1 class="text-3xl font-bold text-gray-900">4択ドリル</h1>
    </header>

    <!-- コントロールパネル -->
    <section class="bg-white p-5 rounded-lg shadow-md mb-8">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <label for="csvSelect" class="block text-sm font-medium text-gray-700 mb-1">問題セット</label>
          <select id="csvSelect" class="w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></select>
        </div>
        <div>
          <label for="numSelect" class="block text-sm font-medium text-gray-700 mb-1">出題数</label>
          <select id="numSelect" class="w-full border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            <option value="5">5問</option>
            <option value="10" selected>10問</option>
            <option value="20">20問</option>
            <option value="30">30問</option>
          </select>
        </div>
        <div class="md:col-span-2 flex items-end">
          <button id="loadBtn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300">
            問題を開始する
          </button>
        </div>
      </div>
      <div class="mt-4 pt-4 border-t">
        <details>
          <summary class="cursor-pointer text-sm font-medium text-gray-600 hover:text-gray-900">詳細設定（出題フィルタリング）</summary>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="minCorrect" class="block text-xs font-medium text-gray-500">除外条件: 最低正解回数</label>
              <input id="minCorrect" type="number" min="1" value="3" class="mt-1 w-full border-gray-300 rounded-md shadow-sm text-sm" />
              <p class="text-xs text-gray-500 mt-1">この回数以上正解した問題を除外</p>
            </div>
            <div>
              <label for="minRate" class="block text-xs font-medium text-gray-500">除外条件: 最低正答率 (%)</label>
              <input id="minRate" type="number" min="0" max="100" value="80" class="mt-1 w-full border-gray-300 rounded-md shadow-sm text-sm" />
              <p class="text-xs text-gray-500 mt-1">この正答率以上の問題を除外</p>
            </div>
          </div>
        </details>
      </div>
       <div class="mt-4 pt-4 border-t flex flex-wrap items-center gap-2">
            <div class="flex items-center gap-2">
                <input id="soundToggle" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600" checked />
                <label for="soundToggle" class="text-sm text-gray-600">正解音</label>
            </div>
            <div class="flex-grow"></div>
            <button id="showStats" class="bg-gray-200 text-gray-700 px-3 py-1.5 rounded-md text-sm font-medium hover:bg-gray-300">学習ログを見る</button>
            <button id="clearStats" class="bg-red-100 text-red-700 px-3 py-1.5 rounded-md text-sm font-medium hover:bg-red-200">ログをリセット</button>
        </div>
        <div id="notice" class="text-sm text-yellow-600 mt-3 text-center"></div>
    </section>

    <!-- 問題表示領域 -->
    <main id="quizArea" class="space-y-6"></main>

    <!-- 結果表示モーダル -->
    <div id="resultModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
      <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4 text-center">
        <h2 class="text-2xl font-bold mb-4">結果発表</h2>
        <p id="scoreText" class="text-4xl font-bold my-4 text-blue-600"></p>
        <p id="feedbackText" class="text-lg text-gray-700 mb-6"></p>
        <div class="space-y-3">
            <button id="retryBtn" class="w-full bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600">同じ問題でもう一度</button>
            <button id="newQuizBtn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">新しい問題で挑戦</button>
            <button id="closeModalBtn" class="w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">閉じる</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------------- 設定 ---------------- */
const csvFilesFallback = ["knowledge.csv", "basic.csv"];
const STORAGE_KEY = "rccmDrillStats_v3"; // ログのバージョン管理

/* ---------------- DOM要素 ---------------- */
const csvSelect = document.getElementById("csvSelect");
const loadBtn = document.getElementById("loadBtn");
const retryBtn = document.getElementById("retryBtn");
const quizArea = document.getElementById("quizArea");
const numSelect = document.getElementById("numSelect");
const minCorrectInput = document.getElementById("minCorrect");
const minRateInput = document.getElementById("minRate");
const soundToggle = document.getElementById("soundToggle");
const clearStatsBtn = document.getElementById("clearStats");
const showStatsBtn = document.getElementById("showStats");
const notice = document.getElementById("notice");
const resultModal = document.getElementById("resultModal");
const scoreText = document.getElementById("scoreText");
const feedbackText = document.getElementById("feedbackText");
const newQuizBtn = document.getElementById("newQuizBtn");
const closeModalBtn = document.getElementById("closeModalBtn");

/* ---- 初期化処理 ---- */
(async function init() {
  let list = [];
  try {
    const r = await fetch("index.json");
    if (r.ok) list = await r.json();
  } catch(e) { /* ignore */ }
  if (!Array.isArray(list) || list.length === 0) list = csvFilesFallback;
  list.forEach(f => {
    const opt = document.createElement("option");
    opt.value = f; opt.textContent = f;
    csvSelect.appendChild(opt);
  });
})();

/* ---- WebAudio APIによる効果音 ---- */
let audioCtx = null;
function ensureAudioCtx(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
function playTone(freq, startOffset, duration=0.16){
  ensureAudioCtx();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = "sine";
  o.frequency.value = freq;
  o.connect(g); g.connect(audioCtx.destination);
  const now = audioCtx.currentTime + startOffset;
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(0.18, now+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, now+duration);
  o.start(now); o.stop(now+duration+0.02);
}
function playDoReMi(){
  if (!soundToggle.checked) return;
  playTone(523.25, 0); // ド
  playTone(587.33, 0.14); // レ
  playTone(659.25, 0.28); // ミ
}

/* ---- CSVデータから問題オブジェクトを生成 ---- */
function buildQuestionsFromCSV(text, filename){
  const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
  return parsed.data.map((row, idx) => {
    const qText = row["問題"] || "";
    const correctText = row["正解"] || "";
    const opt2 = row["選択肢2"] || "";
    const opt3 = row["選択肢3"] || "";
    const opt4 = row["選択肢4"] || "";
    const explanation = row["解説"] || "";
    const hint = row["ヒント"] || "";
    
    if (!qText || !correctText) return null;

    const rawOptions = [correctText, opt2, opt3, opt4].filter(Boolean);
    shuffleArray(rawOptions);

    const optionsMap = {};
    const labels = ["a", "b", "c", "d"];
    rawOptions.forEach((opt, i) => {
      optionsMap[labels[i]] = opt.trim();
    });

    const correctLabel = Object.keys(optionsMap).find(key => optionsMap[key] === correctText.trim());
    const qid = `${filename}::q${idx+1}`;
    return { id: qid, question: qText.trim(), options: optionsMap, answer: correctLabel, explanation: explanation.trim(), hint: hint.trim() };
  }).filter(Boolean);
}

/* ---- 学習ログ（Stats）の操作 ---- */
function loadStats(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }catch(e){return{}} }
function saveStats(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }

/* ---- 出題除外条件の判定 ---- */
function shouldExclude(q, stats, minCorrect, minRate){
  const rec = stats[q.id] || { correct:0, total:0 };
  if (rec.total === 0) return false;
  const rate = (rec.correct / rec.total) * 100;
  return (rec.correct >= minCorrect) && (rate >= minRate);
}

/* ---- 問題の読み込みと表示 ---- */
let currentSet = [], allQuestions = [], statsCache = loadStats(), answeredCount = 0;

async function loadAndRender(isRetry = false) {
  notice.textContent = "";
  quizArea.innerHTML = "";
  answeredCount = 0;
  resultModal.classList.add("hidden");
  statsCache = loadStats();

  const filename = csvSelect.value;
  const num = parseInt(numSelect.value,10) || 10;
  const minCorrect = parseInt(minCorrectInput.value,10) || 3;
  const minRate = parseFloat(minRateInput.value) || 80;

  try {
    if (!isRetry || allQuestions.length === 0 || allQuestions[0].id.split('::')[0] !== filename) {
      const r = await fetch(filename);
      if (!r.ok) throw new Error(`CSVファイル「${filename}」の取得に失敗しました。`);
      const text = await r.text();
      allQuestions = buildQuestionsFromCSV(text, filename);
    }

    let candidates = allQuestions.filter(q => !shouldExclude(q, statsCache, minCorrect, minRate));
    if (candidates.length < num && allQuestions.length >= num) {
      notice.textContent = `苦手問題が${candidates.length}問しかありませんでした。学習済みの問題から補充して出題します。`;
      const excluded = allQuestions.filter(q => shouldExclude(q, statsCache, minCorrect, minRate));
      shuffleArray(excluded);
      candidates.push(...excluded.slice(0, num - candidates.length));
    }
    shuffleArray(candidates);
    currentSet = candidates.slice(0, Math.min(num, allQuestions.length));
    
    if (currentSet.length === 0) {
        notice.textContent = "出題できる問題がありません。詳細設定の条件を緩めてみてください。";
        return;
    }
    renderAll(currentSet);
  } catch(err) {
    quizArea.innerHTML = `<div class="bg-red-100 p-4 rounded text-red-700">${err.message}</div>`;
    console.error(err);
  }
}

/* ---- 全問題カードの描画 ---- */
function renderAll(set){
  quizArea.innerHTML = "";
  set.forEach((q, idx) => {
    const card = document.createElement("div");
    card.className = "bg-white p-6 rounded-lg shadow-md";

    const header = document.createElement("div");
    header.className = "flex justify-between items-start mb-4";
    
    const questionTitle = document.createElement("p");
    questionTitle.className = "font-bold text-lg flex-1";
    questionTitle.innerHTML = `<span class="text-blue-600 font-semibold">問${idx + 1}.</span> ${q.question}`;
    
    const statsBadge = document.createElement("div");
    statsBadge.className = "stats-badge text-xs font-bold px-2.5 py-1 rounded-full text-white whitespace-nowrap ml-4";
    updateStatsBadge(statsBadge, q.id);

    header.appendChild(questionTitle);
    header.appendChild(statsBadge);
    card.appendChild(header);

    if (q.hint) {
        const hintBtn = document.createElement("button");
        hintBtn.className = "bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-yellow-200 mb-4";
        hintBtn.textContent = "ヒントを見る";
        card.appendChild(hintBtn);
        const hintEl = document.createElement("div");
        hintEl.className = "hint";
        hintEl.innerHTML = `<strong class="font-semibold">【ヒント】</strong> ${q.hint}`;
        card.appendChild(hintEl);
        hintBtn.addEventListener("click", () => {
          hintEl.style.display = hintEl.style.display === "block" ? "none" : "block";
          hintBtn.textContent = hintEl.style.display === "block" ? "ヒントを隠す" : "ヒントを見る";
        });
    }

    const optsContainer = document.createElement("div");
    optsContainer.className = "options-container space-y-3";
    Object.keys(q.options).forEach(lbl => {
      const txt = q.options[lbl];
      const opt = document.createElement("div");
      opt.className = "option border border-gray-300 p-3 rounded-lg flex justify-between items-center";
      opt.dataset.label = lbl;
      opt.innerHTML = `<span><span class="font-bold mr-3">${lbl.toUpperCase()}.</span>${txt}</span><span class="feedback-icon"></span>`;
      opt.addEventListener("click", () => onOptionClick(opt, q, card));
      optsContainer.appendChild(opt);
    });
    card.appendChild(optsContainer);

    const exp = document.createElement("div");
    exp.className = "explanation";
    exp.innerHTML = `<p><strong class="font-semibold">【解説】</strong> ${q.explanation || "（解説なし）"}</p>`;
    card.appendChild(exp);

    quizArea.appendChild(card);
  });
}

/* ---- ステータスバッジの更新 ---- */
function updateStatsBadge(badge, qid) {
    const st = statsCache[qid] || { correct: 0, total: 0 };
    const rate = st.total > 0 ? (st.correct / st.total) * 100 : -1;

    badge.textContent = `${st.correct}/${st.total}`;
    badge.classList.remove("bg-gray-400", "bg-red-500", "bg-yellow-500", "bg-green-500");

    if (rate === -1) {
        badge.classList.add("bg-gray-400");
        badge.textContent = "未解答";
    } else if (rate < 50) {
        badge.classList.add("bg-red-500");
    } else if (rate < 80) {
        badge.classList.add("bg-yellow-500");
    } else {
        badge.classList.add("bg-green-500");
    }
}

/* ---- 選択肢クリック時の処理 ---- */
function onOptionClick(optEl, q, cardEl){
  const optsContainer = cardEl.querySelector(".options-container");
  if (optsContainer.classList.contains("answered")) return;
  optsContainer.classList.add("answered");

  answeredCount++;
  const selectedLbl = optEl.dataset.label;
  const correctLbl = q.answer;
  
  cardEl.querySelectorAll(".option").forEach(o => {
    o.classList.add("answered");
    if (o.dataset.label === correctLbl) o.classList.add("correct");
  });

  if (selectedLbl !== correctLbl) {
    optEl.classList.add("incorrect");
  } else {
    playDoReMi();
  }

  const exp = cardEl.querySelector(".explanation");
  if (exp) exp.style.display = "block";

  const stats = loadStats();
  if (!stats[q.id]) stats[q.id] = { correct:0, total:0 };
  stats[q.id].total++;
  if (selectedLbl === correctLbl) stats[q.id].correct++;
  saveStats(stats);
  statsCache = stats;

  const statsBadge = cardEl.querySelector(".stats-badge");
  updateStatsBadge(statsBadge, q.id);

  if (answeredCount === currentSet.length) {
    showResult();
  }
}

/* ---- 結果表示処理 ---- */
function showResult() {
    let correctCount = 0;
    quizArea.querySelectorAll('.options-container.answered').forEach(container => {
        if (container.querySelector('.option.correct.answered[data-label]')) {
             const correctOption = container.querySelector('.option.correct');
             if (correctOption.classList.contains('incorrect') === false) {
                 correctCount++;
             }
        }
    });

    const total = currentSet.length;
    scoreText.textContent = `${correctCount} / ${total} 正解`;
    
    let feedback = '';
    const rate = total > 0 ? (correctCount / total) * 100 : 0;
    if (rate === 100) feedback = '素晴らしい！全問正解です。完璧です！';
    else if (rate >= 80) feedback = '優秀です！この調子で知識を定着させましょう。';
    else if (rate >= 60) feedback = 'まずまずの成績です。間違えた問題の解説をしっかり復習しましょう。';
    else feedback = 'まだまだ伸びしろがありますね。繰り返し挑戦して苦手分野を克服しましょう！';
    feedbackText.textContent = feedback;

    resultModal.classList.remove('hidden');
}

/* ---- ユーティリティ関数 ---- */
function shuffleArray(a){ for (let i=a.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

/* ---- イベントリスナー設定 ---- */
loadBtn.addEventListener("click", () => loadAndRender(false));
retryBtn.addEventListener("click", () => {
    if (currentSet.length > 0) {
        answeredCount = 0;
        resultModal.classList.add("hidden");
        renderAll(currentSet);
    }
});
newQuizBtn.addEventListener("click", () => loadAndRender(false));
closeModalBtn.addEventListener("click", () => resultModal.classList.add("hidden"));

clearStatsBtn.addEventListener("click", () => {
  if (confirm("すべての学習ログをリセットします。本当によろしいですか？")) {
    localStorage.removeItem(STORAGE_KEY);
    statsCache = loadStats();
    alert("学習ログをリセットしました。");
    quizArea.innerHTML = "";
    notice.textContent = "";
  }
});
showStatsBtn.addEventListener("click", () => {
  const s = loadStats();
  const keys = Object.keys(s);
  if (keys.length === 0) return alert("学習ログはまだありません。");
  let msg = "--- 学習ログ ---\n問題ID :: 正答 / 試行 (正答率)\n\n";
  keys.sort().forEach(k => {
    const rate = s[k].total > 0 ? ((s[k].correct/s[k].total)*100).toFixed(1) : "0.0";
    msg += `${k} :: ${s[k].correct} / ${s[k].total} (${rate}%)\n`;
  });
  alert(msg);
});
</script>
</body>
</html>
